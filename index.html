<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prague Trip (Customizable)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #f0f4f8;
            touch-action: pan-y;
            overscroll-behavior-y: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-btn.active { color: #2563eb; border-bottom: 2px solid #2563eb; }
        .leaflet-container { width: 100%; height: 100%; z-index: 1; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative overflow-hidden flex flex-col">

    <header class="glass sticky top-0 z-20 px-4 pt-4 pb-2 border-b border-slate-100">
        <div class="flex justify-between items-start mb-2">
            <div>
                <h1 class="text-xl font-black text-slate-800 tracking-wider flex items-center gap-2">
                    Prague <span class="text-blue-500 text-xs bg-blue-100 px-2 py-0.5 rounded-full">2 Days</span>
                </h1>
                <p class="text-[10px] text-slate-400 font-bold mt-1">è‡ªè¨‚è¡Œç¨‹ç‰ˆ</p>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-slate-400 font-bold">åƒè€ƒåŒ¯ç‡ (CZK)</div>
                <div class="flex flex-col items-end">
                    <span class="text-xs font-bold text-blue-600">1 KÄ â‰ˆ {{ rates.HKD }} HKD</span>
                    <span class="text-xs font-bold text-green-600">1 KÄ â‰ˆ {{ rates.CAD }} CAD</span>
                </div>
            </div>
        </div>

        <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-1">
            <button @click="view = 'todo'" 
                    :class="['flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all', view === 'todo' ? 'bg-slate-800 text-white shadow-lg' : 'bg-slate-100 text-slate-500']">
                ç¸½è¦½
            </button>
            <button v-for="d in days" :key="d.date" @click="selectDate(d.date)"
                    :class="['flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all', selectedDate === d.date && view !== 'todo' ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'bg-slate-100 text-slate-500']">
                {{ d.label }}
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 pb-24 scroll-smooth">
        
        <div v-if="view !== 'todo'" class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-2xl mb-5 flex justify-between items-center shadow-sm border border-blue-100">
            <div>
                <div class="text-3xl font-black text-slate-700">5Â°C</div>
                <div class="text-xs text-slate-500 font-bold mt-1"><i class="fas fa-snowflake mr-1"></i> å†¬å­£å¯’å†·</div>
            </div>
            <div class="text-right">
                <div class="text-xs text-slate-400 font-bold">å¸ƒæ‹‰æ ¼ (12æœˆ)</div>
                <div class="text-[10px] text-slate-400">é«”æ„Ÿ 3Â°C</div>
            </div>
        </div>

        <div class="flex border-b border-slate-100 mb-4 sticky top-0 bg-white z-10" v-if="view !== 'todo'">
            <button @click="tab = 'schedule'" :class="['tab-btn flex-1 py-2 text-xs font-bold', tab === 'schedule' ? 'active' : 'text-slate-400']">è¡Œç¨‹</button>
            <button @click="tab = 'money'" :class="['tab-btn flex-1 py-2 text-xs font-bold', tab === 'money' ? 'active' : 'text-slate-400']">è¨˜å¸³</button>
            <button @click="tab = 'shop'" :class="['tab-btn flex-1 py-2 text-xs font-bold', tab === 'shop' ? 'active' : 'text-slate-400']">è³¼ç‰©</button>
        </div>

        <div v-if="view !== 'todo' && tab === 'schedule'" class="space-y-4 animate-fade-in">
            <div class="h-40 bg-slate-100 rounded-2xl overflow-hidden shadow-inner border border-slate-200 relative">
                <div :id="'map-' + selectedDate" class="leaflet-container"></div>
            </div>

            <div class="space-y-3">
                <div v-for="(item, idx) in currentDayItems" :key="item.id" 
                     @click="editItem('schedule', item)"
                     class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex gap-3 active:scale-[0.98] transition-transform cursor-pointer relative group">
                    <div class="flex flex-col items-center min-w-[40px]">
                        <span class="text-xs font-black text-slate-300">{{ item.time }}</span>
                        <div class="h-full w-0.5 bg-slate-100 my-1 rounded-full"></div>
                    </div>
                    <div class="flex-1 pb-1">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-slate-800 text-sm">{{ item.title }}</h3>
                            <span :class="['text-[10px] px-1.5 py-0.5 rounded font-bold', catColor(item.cat)]">{{ catName(item.cat) }}</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-1 leading-relaxed">{{ item.desc }}</p>
                    </div>
                    <div class="absolute right-3 bottom-3 opacity-0 group-hover:opacity-100 transition-opacity text-xs text-slate-300">
                        <i class="fas fa-pen"></i>
                    </div>
                </div>
                <div v-if="currentDayItems.length === 0" class="text-center py-8 text-slate-400 text-xs">æœ¬æ—¥æš«ç„¡è¡Œç¨‹</div>
            </div>
        </div>

        <div v-if="view !== 'todo' && tab === 'money'" class="space-y-4">
            <div class="bg-slate-800 text-white p-5 rounded-2xl shadow-lg relative overflow-hidden">
                <p class="text-xs text-slate-400 mb-1">æœ¬æ—¥ç¸½æ”¯å‡º (CZK)</p>
                <h2 class="text-3xl font-black tracking-tight">KÄ {{ dayTotal }}</h2>
                <div class="mt-3 pt-3 border-t border-slate-600 grid grid-cols-2 gap-4">
                    <div><p class="text-[10px] text-slate-400">ç´„åˆ HKD</p><p class="font-bold text-blue-300">$ {{ (dayTotal * rates.HKD).toFixed(0) }}</p></div>
                    <div><p class="text-[10px] text-slate-400">ç´„åˆ CAD</p><p class="font-bold text-green-300">$ {{ (dayTotal * rates.CAD).toFixed(1) }}</p></div>
                </div>
            </div>

            <div class="space-y-2">
                <div v-for="exp in currentDayExpenses" :key="exp.id" 
                     @click="editItem('money', exp)"
                     class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 cursor-pointer active:bg-slate-50 transition">
                    <div class="flex items-center gap-3">
                        <div :class="['w-8 h-8 rounded-full flex items-center justify-center text-xs', exp.method === 'card' ? 'bg-purple-100 text-purple-600' : 'bg-green-100 text-green-600']">
                            <i :class="exp.method === 'card' ? 'fas fa-credit-card' : 'fas fa-money-bill'"></i>
                        </div>
                        <div>
                            <div class="font-bold text-slate-700 text-sm">{{ exp.title }}</div>
                        </div>
                    </div>
                    <div class="font-black text-slate-800 text-sm">-{{ exp.amount }}</div>
                </div>
            </div>
            <button @click="openModal('money')" class="w-full py-3 rounded-xl border-2 border-dashed border-slate-200 text-slate-400 text-xs font-bold hover:bg-slate-50 transition">+ è¨˜ä¸€ç­† (Add Expense)</button>
        </div>

        <div v-if="view !== 'todo' && tab === 'shop'" class="space-y-3">
             <div v-for="item in shoppingList" :key="item.id" 
                  class="p-3 rounded-xl border flex justify-between items-center transition-all bg-white border-slate-100">
                <div @click.stop="toggleDone(item, shoppingList)" class="cursor-pointer p-2 -ml-2">
                    <div :class="['w-5 h-5 rounded border flex items-center justify-center transition-colors', item.done ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300']">
                        <i class="fas fa-check text-[10px]" v-if="item.done"></i>
                    </div>
                </div>
                <div @click="editItem('shop', item)" class="flex-1 cursor-pointer px-2">
                    <div :class="['text-sm font-bold', item.done ? 'line-through text-slate-400' : 'text-slate-700']">{{ item.title }}</div>
                    <div class="text-[10px] text-slate-400">é ç®—: {{ item.price ? 'KÄ ' + item.price : '-' }}</div>
                </div>
             </div>
             <button @click="openModal('shop')" class="w-full py-3 rounded-xl border-2 border-dashed border-slate-200 text-slate-400 text-xs font-bold hover:bg-slate-50 transition">+ æ–°å¢å•†å“ (Add Item)</button>
        </div>

        <div v-if="view === 'todo'" class="space-y-6">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-3 border-l-4 border-blue-500 pl-2">æ—…ç¨‹æ¦‚è¦½</h3>
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-500">ç¸½æ”¯å‡º (CZK)</span>
                    <span class="font-black text-slate-700">{{ allExpensesTotal }}</span>
                </div>
                 <div class="flex justify-between text-xs mb-1">
                    <span class="text-slate-500">HKD ç¸½è¨ˆ</span>
                    <span class="font-bold text-blue-600">$ {{ (allExpensesTotal * rates.HKD).toFixed(0) }}</span>
                </div>
                <div class="flex justify-between text-xs">
                    <span class="text-slate-500">CAD ç¸½è¨ˆ</span>
                    <span class="font-bold text-green-600">$ {{ (allExpensesTotal * rates.CAD).toFixed(1) }}</span>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-slate-800 border-l-4 border-orange-500 pl-2">è¡Œå‰å¾…è¾¦</h3>
                </div>
                <div v-for="t in todos" :key="t.id" 
                     class="flex justify-between items-center py-3 border-b border-slate-50 last:border-0">
                    <div class="flex items-center gap-3 cursor-pointer" @click="toggleDone(t, todos)">
                        <div :class="['w-4 h-4 rounded border flex items-center justify-center', t.done ? 'bg-orange-500 border-orange-500 text-white' : 'border-slate-300']">
                            <i class="fas fa-check text-[8px]" v-if="t.done"></i>
                        </div>
                        <span :class="['text-sm', t.done ? 'line-through text-slate-300' : 'text-slate-600']">{{ t.title }}</span>
                    </div>
                    <button @click.stop="deleteDirectly(t.id, todos)" class="text-slate-300 hover:text-red-500 p-2">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <button @click="openModal('todo')" class="w-full mt-2 py-2 rounded-lg bg-orange-50 text-orange-600 text-xs font-bold hover:bg-orange-100 transition">+ æ–°å¢å¾…è¾¦</button>
            </div>

            <div class="p-4 rounded-xl bg-slate-50 text-center">
                <button @click="resetData" class="text-red-400 text-[10px] font-bold underline">é‡ç½®æ‰€æœ‰è³‡æ–™ (Reset)</button>
            </div>
        </div>
    </main>

    <button v-if="view !== 'todo' && tab === 'schedule'" @click="openModal('schedule')" 
            class="absolute bottom-6 right-6 w-12 h-12 bg-slate-800 text-white rounded-full shadow-xl flex items-center justify-center active:scale-90 transition z-30">
        <i class="fas fa-plus"></i>
    </button>

    <div v-if="showModal" class="absolute inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center animate-fade-in" @click.self="showModal = false">
        <div class="bg-white w-full sm:w-[90%] rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl">
            <h3 class="font-black text-xl text-slate-800 mb-4">{{ modalMode === 'add' ? 'æ–°å¢' : 'ç·¨è¼¯' }}é …ç›®</h3>
            
            <div v-if="modalType === 'schedule'" class="space-y-3">
                <div class="flex gap-2">
                    <input v-model="form.time" type="time" class="bg-slate-50 p-3 rounded-xl text-sm font-bold border-none w-1/3">
                    <select v-model="form.cat" class="bg-slate-50 p-3 rounded-xl text-sm font-bold border-none flex-1">
                        <option value="spot">ğŸ“¸ æ™¯é»</option>
                        <option value="food">ğŸ½ï¸ ç¾é£Ÿ</option>
                        <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="show">ğŸ­ è¡¨æ¼”</option>
                    </select>
                </div>
                <input v-model="form.title" placeholder="æ¨™é¡Œ" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border-none">
                <textarea v-model="form.desc" placeholder="å‚™è¨»..." class="w-full bg-slate-50 p-3 rounded-xl text-sm border-none h-20"></textarea>
                 <div class="flex gap-2">
                     <input v-model.number="form.lat" type="number" placeholder="ç·¯åº¦ (Lat)" class="flex-1 bg-slate-50 p-3 rounded-xl text-sm font-bold border-none">
                     <input v-model.number="form.lng" type="number" placeholder="ç¶“åº¦ (Lng)" class="flex-1 bg-slate-50 p-3 rounded-xl text-sm font-bold border-none">
                </div>
            </div>

            <div v-if="modalType === 'money'" class="space-y-3">
                <input v-model="form.title" placeholder="æ¶ˆè²»é …ç›®" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border-none">
                <div class="flex gap-2">
                    <input v-model.number="form.amount" type="number" placeholder="é‡‘é¡ (CZK)" class="flex-1 bg-slate-50 p-3 rounded-xl text-lg font-black border-none">
                    <select v-model="form.method" class="w-1/3 bg-slate-50 p-3 rounded-xl text-sm font-bold border-none">
                        <option value="cash">ç¾é‡‘</option>
                        <option value="card">å¡</option>
                    </select>
                </div>
            </div>

            <div v-if="modalType === 'shop'" class="space-y-3">
                <input v-model="form.title" placeholder="å•†å“åç¨±" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border-none">
                <input v-model.number="form.price" type="number" placeholder="é ç®— (CZK)" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border-none">
            </div>

            <div v-if="modalType === 'todo'" class="space-y-3">
                <input v-model="form.title" placeholder="å¾…è¾¦äº‹é …" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold border-none">
            </div>

            <div class="flex gap-3 mt-6">
                <button v-if="modalMode === 'edit'" @click="deleteFromModal" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl font-bold text-xs">
                    <i class="fas fa-trash-alt mr-1"></i>åˆªé™¤
                </button>
                <div class="flex-1 flex gap-3">
                    <button @click="showModal = false" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold text-sm">å–æ¶ˆ</button>
                    <button @click="saveForm" class="flex-1 py-3 bg-slate-800 text-white rounded-xl font-bold text-sm">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

    // --- ç¡¬ç·¨ç¢¼çš„é è¨­è³‡æ–™ (Hardcoded Data) ---
    const DEFAULT_DATA = {
        schedule: [
            // Day 1: 2025-12-12 èˆŠåŸ & æŸ¥ç†å¤§æ©‹ & å°åŸå€
            { id: 101, date: '2025-12-12', time: '09:00', title: 'èˆŠåŸå»£å ´ (Old Town Square)', cat: 'spot', desc: 'æ‹ç…§ã€æ¬£è³å»£å ´å»ºç¯‰', lat: 50.0875, lng: 14.4214 },
            { id: 102, date: '2025-12-12', time: '10:00', title: 'å¤©æ–‡é˜ (Astronomical Clock)', cat: 'spot', desc: 'æ•´é»çœ‹é˜è¡¨å ±æ™‚ï¼Œå¯ç™»å¡”ä¿¯ç°å»£å ´', lat: 50.0869, lng: 14.4208 },
            { id: 103, date: '2025-12-12', time: '10:30', title: 'çŒ¶å¤ªå€ (Josefov)', cat: 'spot', desc: 'åƒè§€èˆŠçŒ¶å¤ªå¢“åœ°èˆ‡åšç‰©é¤¨', lat: 50.0905, lng: 14.4174 },
            { id: 104, date: '2025-12-12', time: '12:00', title: 'åˆé¤', cat: 'food', desc: 'å»£å ´é™„è¿‘æ·å…‹é¤å»³', lat: 50.0870, lng: 14.4200 },
            { id: 105, date: '2025-12-12', time: '13:00', title: 'ç«è—¥å¡” (Powder Tower)', cat: 'spot', desc: 'æ–°åŸé‡è¦åœ°æ¨™ï¼Œå¯ç™»å¡”æ‹ç…§', lat: 50.0875, lng: 14.4277 },
            { id: 106, date: '2025-12-12', time: '14:00', title: 'æŸ¥ç†å¤§æ©‹ (Charles Bridge)', cat: 'spot', desc: 'æ¬£è³æ©‹ä¸Šé›•åƒèˆ‡ä¼çˆ¾å¡”ç“¦æ²³æ™¯', lat: 50.0865, lng: 14.4116 },
            { id: 107, date: '2025-12-12', time: '15:00', title: 'å°åŸå»£å ´ (Lesser Town Square)', cat: 'spot', desc: 'å°åŸå€å»ºç¯‰ã€æ‹ç…§', lat: 50.0875, lng: 14.4055 },
            { id: 108, date: '2025-12-12', time: '16:00', title: 'è–å°¼å¤æ‹‰æ•™å ‚ (Lesser Town)', cat: 'spot', desc: 'åƒè§€å·´æ´›å…‹å»ºç¯‰', lat: 50.0875, lng: 14.4042 },
            { id: 109, date: '2025-12-12', time: '17:00', title: 'ä¼çˆ¾å¡”ç“¦æ²³éŠèˆ¹', cat: 'show', desc: 'ç´„ 1 å°æ™‚éŠèˆ¹ï¼Œæ¬£è³æ©‹èˆ‡æ²³å²¸å»ºç¯‰', lat: 50.0845, lng: 14.4140 },
            { id: 110, date: '2025-12-12', time: '18:00', title: 'æ™šé¤', cat: 'food', desc: 'æ²³é‚Šé¤å»³æˆ–å»£å ´é™„è¿‘é¤å»³', lat: 50.0850, lng: 14.4100 },
            { id: 111, date: '2025-12-12', time: '19:30', title: 'é»‘å…‰åŠ‡å ´ (Black Light Theatre)', cat: 'show', desc: 'ç´„ 90 åˆ†é˜è¡¨æ¼”ï¼Œç‡ˆå…‰èˆå°ç§€', lat: 50.0840, lng: 14.4200 },
            
            // Day 2: 2025-12-13 å¸ƒæ‹‰æ ¼åŸå ¡ & æ–°åŸ
            { id: 201, date: '2025-12-13', time: '09:00', title: 'å¸ƒæ‹‰æ ¼åŸå ¡ (Prague Castle)', cat: 'spot', desc: 'è–ç¶­ç‰¹å¤§æ•™å ‚ã€çš‡å®®ã€é»ƒé‡‘å··ï¼Œæ—©é»é¿äººæ½®', lat: 50.0906, lng: 14.4017 },
            { id: 202, date: '2025-12-13', time: '12:00', title: 'åˆé¤', cat: 'food', desc: 'åŸå ¡å€é™„è¿‘é¤å»³', lat: 50.0900, lng: 14.4000 },
            { id: 203, date: '2025-12-13', time: '13:00', title: 'ä½©ç‰¹ä»»ç­æœ›å¡” (Petrin Tower)', cat: 'spot', desc: 'æ­çºœè»Šä¸Šå±±ï¼Œåƒè§€ç­æœ›å¡”èˆ‡è¿·å®®', lat: 50.0835, lng: 14.3951 },
            { id: 204, date: '2025-12-13', time: '14:30', title: 'åˆ—ä¾–å»£å ´ (Wenceslas Square)', cat: 'spot', desc: 'åƒè§€å»£å ´åŠå‘¨é‚Šä¸»è¦å»ºç¯‰', lat: 50.0818, lng: 14.4285 },
            { id: 205, date: '2025-12-13', time: '15:30', title: 'æ–°åŸä¸»è¦è¡—é“çŸ­é€›', cat: 'shop', desc: 'Na PÅ™Ã­kopÄ› è¡—é“å•†åº—æˆ–æ­·å²å»ºç¯‰', lat: 50.0840, lng: 14.4260 },
            { id: 206, date: '2025-12-13', time: '16:30', title: 'è€å¸‚æ”¿å»³å‘¨é‚Šå°æ™¯é»', cat: 'spot', desc: 'å¿«é€Ÿåƒè§€æˆ–æ‹å¤–è§€', lat: 50.0850, lng: 14.4200 },
            { id: 207, date: '2025-12-13', time: '17:30', title: 'æ™šé¤', cat: 'food', desc: 'æ–°åŸæ²³é‚Šé¤å»³æˆ–å»£å ´é™„è¿‘é¤å»³', lat: 50.0840, lng: 14.4100 },
            { id: 208, date: '2025-12-13', time: '19:00', title: 'å¤å…¸éŸ³æ¨‚æœƒ / æ­ŒåŠ‡ / èŠ­è•¾è¡¨æ¼”', cat: 'show', desc: 'ç´„ 1.5 å°æ™‚ï¼Œé¸æ“‡åœ‹å®¶æ­ŒåŠ‡é™¢æˆ–æ­·å²æ•™å ‚éŸ³æ¨‚æœƒ', lat: 50.0845, lng: 14.4280 },
            { id: 209, date: '2025-12-13', time: '20:30', title: 'å›é…’åº—', cat: 'spot', desc: 'æ™šé–“çµæŸï¼Œä¼‘æ¯', lat: 50.0875, lng: 14.4214 },
        ],
        // é…åˆæ–°æ—¥æœŸèª¿æ•´é è¨­æ”¯å‡º
        expenses: [
            { id: 1, date: '2025-12-12', title: 'å¤©æ–‡é˜ç™»å¡”é–€ç¥¨', amount: 300, method: 'cash' },
            { id: 2, date: '2025-12-12', title: 'åˆé¤ç‡‰è‚‰', amount: 650, method: 'card' },
            { id: 3, date: '2025-12-13', title: 'åŸå ¡å€é€šç¥¨', amount: 450, method: 'card' },
            { id: 4, date: '2025-12-13', title: 'çºœè»Šç¥¨', amount: 60, method: 'cash' },
            { id: 5, date: '2025-12-12', title: 'é»‘å…‰åŠ‡å ´é–€ç¥¨', amount: 900, method: 'card' },
        ],
        shop: [
            { id: 1, title: 'æ°´æ™¶æ¯', price: 1200, done: false },
            { id: 2, title: 'æœ¨å¶ç©å…·', price: 450, done: false }
        ],
        todos: [
            { id: 1, title: 'é è¨‚é»‘å…‰åŠ‡å ´é–€ç¥¨', done: false },
            { id: 2, title: 'ä¸‹è¼‰é›¢ç·šåœ°åœ–', done: false }
        ]
    };

    // æ›´æ”¹å„²å­˜ Keyï¼Œç¢ºä¿èˆŠç€è¦½å™¨ä¸æœƒè®€å–åˆ°èˆŠçš„è¡Œç¨‹æ•¸æ“š
    const STORAGE_KEY = 'prague_trip_v2025_dec_fixed_v3'; 

    createApp({
        setup() {
            // State
            const view = ref('schedule');
            const tab = ref('schedule');
            const selectedDate = ref('2025-12-12'); // Updated initial date
            const days = ref([ // Updated dates
                { date: '2025-12-12', label: 'Day 1' },
                { date: '2025-12-13', label: 'Day 2' }
            ]);
            // Kept rates as is
            const rates = ref({ HKD: 0.34, CAD: 0.06 });

            const schedule = ref([]);
            const expenses = ref([]);
            const shoppingList = ref([]);
            const todos = ref([]);

            // Modal
            const showModal = ref(false);
            const modalType = ref('');
            const modalMode = ref('add');
            // Added lat/lng default values
            const form = ref({ lat: null, lng: null }); 

            // Load Data
            const loadData = () => {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const data = JSON.parse(stored);
                    schedule.value = data.schedule;
                    expenses.value = data.expenses;
                    shoppingList.value = data.shop;
                    todos.value = data.todos;
                } else {
                    resetData();
                }
            };

            const resetData = () => {
                schedule.value = JSON.parse(JSON.stringify(DEFAULT_DATA.schedule));
                expenses.value = JSON.parse(JSON.stringify(DEFAULT_DATA.expenses));
                shoppingList.value = JSON.parse(JSON.stringify(DEFAULT_DATA.shop));
                todos.value = JSON.parse(JSON.stringify(DEFAULT_DATA.todos));
                save();
                window.location.reload();
            };

            const save = () => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    schedule: schedule.value,
                    expenses: expenses.value,
                    shop: shoppingList.value,
                    todos: todos.value
                }));
            };

            // Computed
            const currentDayItems = computed(() => {
                return schedule.value
                    .filter(i => i.date === selectedDate.value)
                    .sort((a, b) => a.time.localeCompare(b.time));
            });

            const currentDayExpenses = computed(() => expenses.value.filter(e => e.date === selectedDate.value));
            const dayTotal = computed(() => currentDayExpenses.value.reduce((sum, e) => sum + e.amount, 0));
            
            const allExpensesTotal = computed(() => expenses.value.reduce((sum, e) => sum + e.amount, 0));

            // Helpers
            // Added 'show' category
            const catName = (c) => ({ spot: 'æ™¯é»', food: 'ç¾é£Ÿ', shop: 'è³¼ç‰©', show: 'è¡¨æ¼”' }[c] || 'å…¶ä»–');
            // Added 'show' color
            const catColor = (c) => ({ spot: 'bg-indigo-100 text-indigo-600', food: 'bg-orange-100 text-orange-600', shop: 'bg-pink-100 text-pink-600', show: 'bg-yellow-100 text-yellow-600' }[c]);

            // Actions
            const selectDate = (d) => {
                selectedDate.value = d;
                view.value = 'day';
                tab.value = 'schedule'; // Force show schedule tab
                nextTick(initMap);
            };

            const openModal = (type) => {
                modalType.value = type;
                modalMode.value = 'add';
                form.value = { 
                    date: selectedDate.value, 
                    time: new Date().toTimeString().slice(0, 5), // Current time for convenience
                    cat: 'spot', 
                    method: 'cash', 
                    title: '', 
                    done: false,
                    lat: null,
                    lng: null
                };
                showModal.value = true;
            };

            const editItem = (type, item) => {
                modalType.value = type;
                modalMode.value = 'edit';
                // Use spread operator for copy
                form.value = { ...item }; 
                showModal.value = true;
            };

            const saveForm = () => {
                const data = { ...form.value };
                let targetList;
                if (modalType.value === 'schedule') targetList = schedule;
                else if (modalType.value === 'money') targetList = expenses;
                else if (modalType.value === 'shop') targetList = shoppingList;
                else if (modalType.value === 'todo') targetList = todos;

                if (modalMode.value === 'edit') {
                    const idx = targetList.value.findIndex(i => i.id === data.id);
                    if (idx !== -1) targetList.value[idx] = data;
                } else {
                    data.id = Date.now();
                    targetList.value.push(data);
                }
                save();
                showModal.value = false;
                if(modalType.value === 'schedule') nextTick(initMap);
            };

            const deleteFromModal = () => {
                if(!confirm('ç¢ºå®šåˆªé™¤æ­¤é …ç›®?')) return;
                let targetList;
                if (modalType.value === 'schedule') targetList = schedule;
                else if (modalType.value === 'money') targetList = expenses;
                else if (modalType.value === 'shop') targetList = shoppingList;
                else if (modalType.value === 'todo') targetList = todos;

                targetList.value = targetList.value.filter(i => i.id !== form.value.id);
                save();
                showModal.value = false;
                if(modalType.value === 'schedule') nextTick(initMap);
            };

            const deleteDirectly = (id, list) => {
                 if(!confirm('ç¢ºå®šåˆªé™¤?')) return;
                 const idx = list.findIndex(i => i.id === id);
                 if(idx !== -1) {
                     list.splice(idx, 1);
                     save();
                 }
            };

            const toggleDone = (item, list) => {
                item.done = !item.done;
                save();
            };

            // Map Logic
            let mapInstance = null;
            const initMap = () => {
                const containerId = 'map-' + selectedDate.value;
                const container = document.getElementById(containerId);
                if (!container) return; // Map container must exist

                if (mapInstance) {
                    mapInstance.off();
                    mapInstance.remove();
                    mapInstance = null;
                }
                
                container.innerHTML = ''; 

                const itemsWithCoords = currentDayItems.value.filter(item => item.lat && item.lng);
                
                if (itemsWithCoords.length === 0) {
                     // Set a default view for the city if no points
                    mapInstance = L.map(containerId, { zoomControl: false }).setView([50.0875, 14.4214], 13);
                } else {
                     // Set map view to the first point
                    mapInstance = L.map(containerId, { zoomControl: false }).setView([itemsWithCoords[0].lat, itemsWithCoords[0].lng], 13);
                }

                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: 'OpenStreetMap'
                }).addTo(mapInstance);

                const markers = [];
                itemsWithCoords.forEach(item => {
                    if (item.lat && item.lng) {
                        const marker = L.marker([item.lat, item.lng]).addTo(mapInstance)
                            .bindPopup(`<b>${item.title}</b><br>${item.time} - ${catName(item.cat)}`);
                        markers.push([item.lat, item.lng]);
                    }
                });

                if (markers.length > 1) {
                    mapInstance.fitBounds(markers, { padding: [30, 30] });
                } else if (markers.length === 1) {
                    mapInstance.setView(markers[0], 15);
                }
            };

            watch(() => tab.value, (newTab) => {
                if (newTab === 'schedule') nextTick(initMap);
            });

            onMounted(() => {
                loadData();
                selectDate(selectedDate.value); // Initialize map and view with the new date
            });

            return {
                view, tab, selectedDate, days, rates,
                schedule, expenses, shoppingList, todos,
                currentDayItems, currentDayExpenses, dayTotal, allExpensesTotal,
                catName, catColor,
                selectDate, openModal, editItem, saveForm, deleteFromModal, deleteDirectly, toggleDone,
                showModal, modalType, modalMode, form,
                save, resetData
            };
        }
    }).mount('#app');
</script>
</body>
</html>
